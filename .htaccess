#Make sure .htaccess files aren't disabled.

#Apache will serve files with a different charset, and break unicode characters, unless this is set.
AddDefaultCharset UTF-8

RewriteEngine On
#Redirect http to https
RewriteCond %{HTTPS} off
RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

#Strict transport security - force https in future.
Header always set Strict-Transport-Security "max-age=63072000; preload; includeSubdomains" env=HTTPS


LoadModule brotli_module modules/mod_brotli.so
<IfModule mod_brotli.c>
	BrotliCompressionQuality 9 #0-11. 9 is best before performance cliff hit.

	BrotliFilterNote Input brotli_input_info
	BrotliFilterNote Output brotli_output_info
	BrotliFilterNote Ratio brotli_ratio_info
	LogFormat '"%r" %{brotli_output_info}n/%{brotli_input_info}n (%{brotli_ratio_info}n%%)' brotli
	CustomLog "logs/brotli_log" brotli

	#Don't compress content which is already compressed
	SetEnvIfNoCase Request_URI \
	\.(gif|jpe?g|png|swf|woff|woff2) no-brotli dont-vary

	#Make sure proxies don't deliver the wrong content
	Header append Vary User-Agent env=!dont-vary

	AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/x-javascript application/javascript application/json application/x-font-ttf application/vnd.ms-fontobject image/x-icon
</IfModule>


SetOutputFilter DEFLATE
#Max deflate compression level. Levels are 0-9
#DeflateCompressionLevel 9

#TODO: Brotli doesn't appear to be working. Compression levels are resulting in not allowed here error.
#SetOutputFilter BROTLI_COMPRESS
#Max brotli compression levels before speed totally plummets. Levels are 0-11.
#BrotliCompressionQuality 9
