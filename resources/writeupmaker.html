<p>Your progress in creating this writeup is automatically saved. It will be available the next time this page is loaded, unless one of the following occours:<br>
1. localStorage is cleared. Browsers may do this if you click "clear cache" or "clear cookies and other side data".<br>
2. Multiple tabs of this page open at once - The tabs will overwrite each other.</p>
<br>
<button onclick="clearAllFields()">Clear All Fields</button>

<p>Basic River Information</p>
<input id="name" type="text" placeholder="River Name (Required)"  style="width:100%">
<br>
<input id="section" placeholder="Section Name (Required)" type="text"  style="width:100%">
<br>
<select id="skill" onchange="UpdateWriteup()">
  <option value="" selected>Skill (Required)</option>
  <option value="FW">Flat Water</option>
  <option value="B">Beginner</option>
  <option value="N">Novice</option>
  <option value="N+">Novice Plus</option>
  <option value="LI-">Low-Intermediate Minus</option>
  <option value="LI">Low-Intermediate</option>
  <option value="LI+">Low-Intermediate Plus</option>
  <option value="I-">Intermediate Minus</option>
  <option value="I">Intermediate</option>
  <option value="I+">Intermediate Plus</option>
  <option value="HI-">High-Intermediate Minus</option>
  <option value="HI">High-Intermediate</option>
  <option value="HI+">High-Intermediate Plus</option>
  <option value="A-">Advanced Minus</option>
  <option value="A">Advanced</option>
  <option value="A+">Advanced Plus</option>
  <option value="E-">Expert Minus</option>
  <option value="E">Expert</option>
  <option value="E+">Expert Plus</option>
</select>
<br>
<input id="class" placeholder="Class (Optional)" type="text"  style="width:100%">
<br>
<input id="state" placeholder="State (Required if no GPS coordinates provided)" type="text"  style="width:100%" list="stateOptions">
<datalist id="stateOptions"></datalist>
<br>
<select id="rating" onchange="UpdateWriteup()">
  <option selected value="">Rating (Optional)</option>
</select>

<p>More Section Statistics (Optional)</p>
This river has dam releases <input id="dam" type="checkbox">
<br>
<input id="length" placeholder="Length of Section (Currently not used)" type="text"  style="width:100%">
<br>
<input id="averagegradient" type="text" placeholder="Average gradient (feet per mile)"  style="width:100%">
<br>
<input id="maxgradient" type="text" placeholder="Maximum gradient (feet per mile)"  style="width:100%">
<br>

<p>Gauge Information (Strongly Reccomended)</p>
<input id="usgs" type="text" placeholder="USGS Gauge Number"  style="width:100%">
<br>
<input id="relatedusgs" type="text" placeholder="Other Related USGS Gauges (comma seperated list)"  style="width:100%">
<br>
<p>Relative Water Levels (Reccomended)</p>
<p>Units are required (ft, feet, or cfs). Examples: 1.67ft, 1992cfs, 3.91 ft, 391 cfs, 2.42 feet</p>
<input id="minrun" type="text" placeholder="Minimum runnable water level"  style="width:100%">
<br>
<input id="maxrun" type="text" placeholder="Maximum runnable water level"  style="width:100%">
<br>
<input id="lowflow" type="text" placeholder="Low Water"  style="width:100%">
<br>
<input id="midflow" type="text" placeholder="Ideal Level"  style="width:100%">
<br>
<input id="highflow" type="text" placeholder="High Water"  style="width:100%">
<br>
<p>GPS Coordinates (Reccomended):</p>
<p>Note: Rivers.run should work with most coordinate formats. If you encounter an issue with one of them, please email <a href="support@rivers.run">support@rivers.run</a></p>
<input id="plat" type="text" placeholder="Put-in GPS Latitude"  style="width:100%">
<br>
<input id="plon" type="text" placeholder="Put-in GPS Longitude"  style="width:100%">
<br>
<input id="tlat" type="text" placeholder="Take-out GPS Latitude"  style="width:100%">
<br>
<input id="tlon" type="text" placeholder="Take-out GPS Longitude"  style="width:100%">
<br>
<p>Approxtimate Coordinates (Optional, Will NOT be shown to user)</p>
<p>If you did not specify put-in or take-out coordinates, these coordinates will be used for geolocation searching</p>
<input id="hidlat" type="text" placeholder="Approxtimate GPS Longitude"  style="width:100%">
<input id="hidlon" type="text" placeholder="Approxtimate GPS Longitude"  style="width:100%">
<br>
<p>American Whitewater River Number (Optional)</p>
<input id="aw" type="text" placeholder="AW River Number"  style="width:100%">
<br>
<p>Tags (Optional, used by search tools)</p>
<input id="tags" type="text" placeholder="Input Tags Here, seperated by commas"  style="width:100%">
<br>
<p>Tag Examples: CCCWOR, Ice-Cream, Monacacy, NC, PA, TN, CA, MI, WV, ext.
<br>
Put C1 after the tag if you can get to the river within an hour from that area (ex. CCCWORC1), put C if you can get to the river in 1-2 hours from that area (ex. CCCWORC), and put nothing if it takes 2+ hours (ex. CCCWOR). Do not put the tag if it is unreasonable to paddle the river from the area.</p>
<br>

<p>Comments (Optional. Not shown on site, but visible to all editors. )</p>
<input id="comments" type="text" placeholder="Comments about this writeup"  style="width:100%">
<br>

<script>
	var rating = document.getElementById("rating")
	for (let i=4;i<21;i++) {
		let stars = i/4
		let option = document.createElement("option")
		option.value = stars
		option.innerHTML = stars + " Stars"
		rating.appendChild(option)
	}
</script>
<br><br>

<style>
	
	input {
		padding-left: 5px;
	}
	
	@media (prefers-color-scheme: dark) {
		html, body {
			background-color: black;
			color: white;
		}
		
		input {
			background-color:black;
			color: white;
			border: 1px solid #777;
		}
		
		input::placeholder {
			color: #cccccc;
		}
		
		#Output {
			filter: invert(1);
		}	
		
		.ql-toolbar {
			background-color: white;
			filter: invert(1);
		}
	}
	
</style>

<!-- Quill can misbehave. Add a button to reset it.-->
<button onclick="if (confirm('Are you sure you want to clear the writeup?')) {quill.root.innerHTML = '';UpdateWriteup()}">Clear Writeup</button>
<div id="editor-container" style="height: fit-content; max-height:80vh; min-height:150px;"></div>
<br>



<br><br><br>
<button onclick="copyStringToClipboard()">Copy Output To Clipboard</button><button onclick="submitAsNewRiver()">Submit As New River Suggestion</button><a href="https://drive.google.com/drive/u/0/folders/1yq4C_4aG_7E18nAxYofLbKHmnZFI-0R_" target="_blank"> Open Review Queue</a>
<textarea id="Output" readonly="" placeholder="Output Will Appear Here."rows = "50" style="width:100%"></textarea>
<br>


<script src="quill.min.js"></script>
<link rel="stylesheet" type="text/css" href="quill.snow.css">
<script>
function copyStringToClipboard() {
   var str = document.getElementById("Output").value
   // Create new element
   var el = document.createElement('textarea');
   // Set value (string to be copied)
   el.value = str;
   // Set non-editable to avoid focus and move outside of view
   el.setAttribute('readonly', '');
   el.style = {position: 'absolute', left: '-9999px'};
   document.body.appendChild(el);
   // Select text inside element
   el.select();
   // Copy text to clipboard
   document.execCommand('copy');
   // Remove temporary element
   document.body.removeChild(el);
}




//Create writeup editor
var toolbarOptions = [
    ['bold', 'italic', 'underline', 'strike'],
    ['blockquote'],

    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    [{ 'script': 'sub'}, { 'script': 'super' }],

    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

    [ 'link', 'image', 'video'], //Image and video handlers are overwritten.
    //[{ 'color': [] }, { 'background': [] }], //CSP breaks inline style.

    ['clean']
];

var quill = new Quill('#editor-container', {
modules: {
toolbar: toolbarOptions
},
placeholder: 'Create your writeup...',
theme: 'snow'
});

quill.on('text-change', function() {
    UpdateWriteup()
});

let API_KEY = "AIzaSyD-MaLfNzz1BiUvdKKfowXbmW_v8E-9xSc"

quill.getModule("toolbar").handlers.image = function imageHandler(value) {
        let File_ID = prompt("Please type in the File ID of the image in Google Drive. (To get the file id, click on the file, click the three dot menu in the top right hand corner, click open in new window. Copy out the section between /d/ and /view).")
        quill.insertEmbed(quill.getSelection(true), 'image', 'https://www.googleapis.com/drive/v3/files/' + File_ID + '?alt=media&key=' + API_KEY);
}

quill.getModule("toolbar").handlers.video = function imageHandler(value) {
        let File_ID = prompt("Please type in the File ID of the video in Google Drive. (To get the file id, click on the file, click the three dot menu in the top right hand corner, click open in new window. Copy out the section between /d/ and /view).")
        quill.insertEmbed(quill.getSelection(true), 'video', 'https://www.googleapis.com/drive/v3/files/' + File_ID + '?alt=media&key=' + API_KEY);
}
	
	
	
	
let datalist = document.getElementById("stateOptions")

let states = {"DE":"Delaware","DC":"District of Columbia","FL":"Florida","GA":"Georgia","HI":"Hawaii","ID":"Idaho","IL":"Illinois","IN":"Indiana","IA":"Iowa","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","ME":"Maine","MD":"Maryland","MA":"Massachusetts","MI":"Michigan","MN":"Minnesota","MS":"Mississippi","MO":"Missouri","MT":"Montana","NE":"Nebraska","NV":"Nevada","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NY":"New York","NC":"North Carolina","ND":"North Dakota","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VT":"Vermont","VA":"Virginia","WA":"Washington","WV":"West Virginia","WI":"Wisconsin","WY":"Wyoming","AS":"American Samoa","GU":"Guam","MP":"Northern Mariana Islands","PR":"Puerto Rico","UM":"U.S. Minor Outlying Islands","VI":"U.S. Virgin Islands","AL":"Alabama","AK":"Alaska","AZ":"Arizona","AR":"Arkansas","CA":"California","CO":"Colorado","CT":"Connecticut"}

for (let stateCode in states) {
	let option = document.createElement("option")
	option.value = stateCode
	option.innerHTML = states[stateCode]
	datalist.appendChild(option)
}
	

var List = ["name","section","skill","rating","writeup","tags","state","usgs","aw","plat","plon","tlat","tlon","hidlat","hidlon","maxrun","minrun","lowflow","midflow","highflow","dam","relatedusgs","class","averagegradient","maxgradient","length", "comments"]

List.forEach(function(value){
  console.log(value)
  console.log(document.getElementById(value))
  if (value !== "writeup") {
	  let elem = document.getElementById(value)
	  if (elem.type === "checkbox") {
	  	elem.checked = (localStorage.getItem(value) === "true")
	  }
	  else {
      	elem.value = localStorage.getItem(value)
	  }
      elem.addEventListener("keyup", UpdateWriteup)
  }
  else {
      //Start quill off with stored value.
      quill.root.innerHTML = localStorage.getItem(value)
  }
})

function clearAllFields() {
    if (confirm("Are you sure you want to clear all fields?")) {
        List.forEach((value) => {
            localStorage.removeItem(value)
        })
        window.location.reload()
    }
}

	
function getOutputText() {
    var Text = ""
    List.forEach(function(value, index){
      if (value === "writeup") {
          Text += "\n" + value + ": " + quill.root.innerHTML
      }
      else if (value === "relatedusgs") {
          Text += "\n" + value + ": "
          //Convert comma seperated list into javascript list
          if (document.getElementById(value).value.trim().split(" ").join("").split(",").length > 0) {
              Text += JSON.stringify(document.getElementById(value).value.trim().split(" ").join("").split(","))
          }
      }
      else {
          Text += "\n" + value + ": " + document.getElementById(value).value.trim()
      }
    })
	return Text.trim()
}
	
function UpdateWriteup() {

    List.forEach(function(value){
        if (value !== "writeup") {
			let elem = document.getElementById(value)
			let text;
			
			if (elem.type === "checkbox") {
				text = elem.checked
			}
			else {
				text = elem.value.trim()			
			}
			
            localStorage.setItem(value, text)
        }
        else {
            //Save quill to localStorage
            localStorage.setItem(value, quill.root.innerHTML)
        }
    })


    document.getElementById("Output").value = getOutputText()
}
UpdateWriteup()
//Initial update
	
	
	
function submitAsNewRiver() {
	 let url = "https://script.google.com/macros/s/AKfycbxhxpImVHh-UBAlVOGppV4wYRVtO4ldLHn_q128vckXshCl6B8/exec"
	 let type = "river"
	 let name = prompt("What would you like the file name for this section to be? ")
	 let editors = prompt("Optional: Enter email addresses that you would like to give edit access to this file. (comma seperated list)")
	 
	 console.log(name)
	 console.log(editors)
	
	let nonce = Math.round(Math.random() * (2**30))
	
	let requestURL = url + "?type=" + type + "&name=" + name + "&nonce=" + nonce + (editors?("&editors=" + editors):"")
	console.log(requestURL) 
	
	 let request = fetch(requestURL, {
		method: "POST",
		 body: getOutputText(),
		 mode: "no-cors"
	 })
	 
	 alert("We are attempting to submit your river. You should receive an alert in about 10 seconds if it succeeds. ")

	;(async function() {
		let response = await request
		let result = await response.text()
		console.log(result)
		const API_KEY = "AIzaSyD-MaLfNzz1BiUvdKKfowXbmW_v8E-9xSc"
		let checkReq = await fetch("https://www.googleapis.com/drive/v3/files/16sAPFOmyzg5Ds-oHdt9Ra5LKmhjXNC6Q0_2WMBXaCtU/export?mimeType=text/plain&key=" + API_KEY, {cache: "no-store"})
		let checkResp = await checkReq.text()
		console.log(checkResp)
		console.log(name + nonce)
		if (checkResp === (name + nonce)) {
			alert("Your river has been successfully submitted. ")
		}
		else {
			alert("Submission appears to have failed. Please try again. (you can confirm that it failed or succeeded by clicking on 'Open Review Queue')")
		}
	 }())
}
	
</script>

<script src="../packages/allPages.js"></script>
