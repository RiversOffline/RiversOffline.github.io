
<script>
        function download(name, data, mimetype) {

        let stuff = data;
        let blob = new Blob([stuff],{
            type: mimetype
        });

        if(window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, name);
            }
            else{
                let elem = window.document.createElement('a');
                elem.href = window.URL.createObjectURL(blob);
                elem.download = name;        
                document.body.appendChild(elem);
                elem.click();        
                document.body.removeChild(elem);
            }

        }
  
      
      
  
        let googlecloudrequestrate = 10;
        
        function urlcreate(File_ID) {
            let API_KEY = "AIzaSyD-MaLfNzz1BiUvdKKfowXbmW_v8E-9xSc"
            return 'https://www.googleapis.com/drive/v3/files/' + File_ID + '/export?mimeType=text%2Fplain&key=' + API_KEY       
        }

        window.wait = function(ms) {
          return new Promise(resolve => {
            setTimeout(resolve, ms);
          });
        };

        (async function() {
        let fileidcontent = await fetch(urlcreate("19B237gWAoRLOzz5Hh4AO6nD1yxVWxL1LmTLgYkg8JrQ"))
        fileidcontent = await fileidcontent.text()
        fileidcontent = fileidcontent.split("\n")
        
        let fileids = []
        for (var i=0;i<fileidcontent.length;i++) {
          if (i%2 === 1) {
            fileids.push(fileidcontent[i])
          }
        }
        
        
        self.retry  = []
        self.complete = []
        self.failed = []

        window.load = async function(id) {
                let request = await fetch(urlcreate(id))
                if (request.ok) {
                        request = await request.text()
                        complete.push(request)
                        console.log(complete.length + " items have now been loaded successfully!")
                }
                else if (request.status == 403) {
                        retry.push(id)
                        console.log("403 error requesting the file with a file id of " + id)
                }
                else {
                        failed.push(id)
                        console.warn("Requesting the file with a fild id of " + id + " failed. The response is below")
                        console.warn(request)
                }
        }
                
        for (let i=0;i<fileids.length;i++) {
                load(fileids[i])
                await wait(1000/googlecloudrequestrate)
        }
        
        await wait(1000) //Let quota refresh
                
        for (let i=0;i<retry.length;i++) {
                load(fileids[i])
                //Use 2000 instead of the 1000 it should be- I want the retries to never 403
                await wait(2000/googlecloudrequestrate)
        }                
                
        for (let i=0;i<failed.length;i++) {
                console.error("Loading of file with file id of " + failed[i] + " failed.")
        }
              
        await wait(500) //Let requests finish

        for (let i=0;i<complete.length;i++) {
                let item = complete[i].split("\n")
                let obj = {}
                for (let i=0;i<item.length;i++) {
                        let prop = item[i]
                        let name = prop.slice(0,prop.indexOf(":"))
                        name = name.toLowerCase()
                        let value = prop.slice(prop.indexOf(":") + 1)
                        
                        //Google Docs adds \r terminators to the end
                        if (value.endsWith("\r")) {
                                value = value.slice(0,-1)
                                value = value.trim()
                        }
                        
                        if (String(value).length !== 0) {
                                obj[name] = value
                        }
                }
                complete[i] = obj    
        }        
                
        console.log(complete)      
        let string = "riverarray = " + JSON.stringify(complete)
        download("riverarray.js", string, "application/json")
                
                
        }())
  
        


</script>
